<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>CRUD BOOKS</title>
    <link rel="stylesheet" href="../CSS/style_book.css" />
  </head>
  <body>
    <div class="wrapper">
        <table id="crud">
            <caption>BOOKS</caption>
            <thead>
                <tr>
                    <td>Name</td>
                    <td>Author</td>
                    <td>Unit Price</td>
                    <td>Actions</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        <button class="updateBook">Edit</button>
                        <button class="deleteBook">Delete</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <button class="add-category">Add Book</button>
    </div>
    <div class="popup">
        <form action="">
            <input type="id" placeholder="id" name="id">
            <input type="imageLink" placeholder="imageLink" name="imageLink">
            <input type="name" placeholder="name" name="name">
            <input type="submit" value="submit" >
        </form>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getDatabase, ref, child, get, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";


      const firebaseConfig = {
        apiKey: "AIzaSyALP0s0RbtbJ2glwArGQ1s_yQ9kwhGicpI",
        authDomain: "thestore-55f0f.firebaseapp.com",
        databaseURL: "https://thestore-55f0f-default-rtdb.firebaseio.com",
        projectId: "thestore-55f0f",
        storageBucket: "thestore-55f0f.appspot.com",
        messagingSenderId: "318647012345",
        appId: "1:318647012345:web:fc1ceaf122b8376eaa8b28",
        measurementId: "G-1XNCYRDHHN",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase();
      const bookRef = ref(db, "books/");

      onValue(bookRef, (snapshot) => {
        const data = snapshot.val();
        var htmlData = "";
        for (var key in data) {
          var book = data[key];
          var name = book.name;
          var author = book.author;
          var unitPrice = book.unitPrice;
          htmlData += `
            <tr>
              <td>${name}</td>
              <td>${author}</td>
              <td>${unitPrice}</td>
              <td>
                <button onclick="updateBook('${key}', '${name}', '${author}', '${unitPrice}')">Update</button>
                <button onclick="deleteBook('${key}')">Delete</button>
              </td>
            </tr>
          `;
        }
        document.querySelector("tbody").innerHTML = htmlData;
      });

      function updateBook(key, name, author, unitPrice) {
        // Hiển thị popup
        document.getElementById("newName").value = name;
        document.getElementById("newAuthor").value = author;
        document.getElementById("newUnitPrice").value = unitPrice;
        document.getElementById("updatePopup").style.display = "block";

        // Lấy key của cuốn sách
        var currentKey = key;

        // Xử lý khi nhấn nút "Save Changes"
        document.getElementById("saveChanges").onclick = function () {
          const newName = document.getElementById("newName").value;
          const newAuthor = document.getElementById("newAuthor").value;
          const newUnitPrice = document.getElementById("newUnitPrice").value;

          if (newName !== "" && newAuthor !== "" && newUnitPrice !== "") {
            const updates = {
              ["/books/" + currentKey]: {
                name: newName,
                author: newAuthor,
                unitPrice: newUnitPrice,
              },
            };
            update(ref(db), updates);
            document.getElementById("updatePopup").style.display = "none";
          } else {
            alert("Please fill in all fields.");
          }
        };
      }

      function deleteBook(key) {
        // Xóa cuốn sách khỏi Firebase
        if (confirm("Are you sure you want to delete this book?")) {
          remove(child(ref(db), "books/" + key));
        }
      }

      // Xử lý khi nhấn nút "Close" trong popup
      var closeBtn = document.getElementsByClassName("close")[0];
      closeBtn.onclick = function () {
        document.getElementById("updatePopup").style.display = "none";
      };

      // Xử lý khi nhấn bên ngoài popup
      window.onclick = function (event) {
        if (event.target == document.getElementById("updatePopup")) {
          document.getElementById("updatePopup").style.display = "none";
        }
      };
    </script>
  </body>
</html>